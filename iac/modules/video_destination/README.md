# video_destination

## Function

- Contains terraform files for the S3 destination. This is currently us-east-1. The destination verbiage is used to represent the final location of the data. Other regions data will flow into the S3 bucket here via cross region replication.

## Module location(to give a frame of reference where it's used)

- Parent module of children module video_detail

## Contains the following terraform files

main.tf - main entrypoint into module  
s3-late.tf - creates a basic s3 bucket with KMS encryption and versioning turned on for the late arriving data.  
s3-sess.tf - creates a basic s3 bucket with KMS encryption and versioning turned on for the session data.  
s3-raw.tf - creates a basic s3 bucket with KMS encryption and versioning turned on for the raw data.  
variables.tf - variables needed by this module.  
versions.tf - controls versioning of terraform resources
alarms.tf - cloudwatch alarms
ecs-task-loader.tf - ecs task loader which reads from raw stream and delivers to slow prod and data mart raw streams
lambda_s3.tf - lambda which counts s3 objects in late arriving bucket
nsg-loader.tf - security group for ecs loader
role_loader.tf - role for ecs loader
sqs-loader-dlq.tf - dead letter queue for ecs loader
sqs-outbound.tf - sqs bucket for ecs loader to process from

## Variables

| Name                              | Description                                                                                                                                                                                                                                                                                                                 |       Type        | Default | Required |
| --------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :---------------: | :-----: | :------: |
| app                               | Name of the application. This value should usually match the application tag below.                                                                                                                                                                                                                                         |      string       |         |   yes    |
| saml_role                         | The role that will have access to the S3 bucket, this should be a role that all members of the team have access to.                                                                                                                                                                                                         |      string       |         |   yes    |
| tags                              | A map of the tags to apply to various resources. The required tags are: <br>+ `application`, name of the app <br>+ `environment`, the environment being created <br>+ `team`, team responsible for the application <br>+ `contact-email`, contact email for the _team_ <br>+ `customer`, who the application was create for |        map        | `<map>` |   yes    |
| internal                          | Whether the application load balancers use private or public subnets.                                                                                                                                                                                                                                                       |       bool        |  true   |   yes    |
| kpl_port                          | The port the api will communicate with the kpl on.                                                                                                                                                                                                                                                                          |        int        |         |   yes    |
| log_level                         | The verbosity of the logging. debug, info, none                                                                                                                                                                                                                                                                             |      string       |         |   yes    |
| deregistration_delay              | Elastic Load Balancing stops sending requests to targets that are deregistering. By default, Elastic Load Balancing waits 300 seconds before completing the deregistration process, which can help in-flight requests to the target to complete                                                                             |      string       |         |   yes    |
| common_environment                | The common environment name(i.e. dev, test, prod, etc)                                                                                                                                                                                                                                                                      |      string       |         |   yes    |
| vpc                               | The VPC to use for the Fargate cluster                                                                                                                                                                                                                                                                                      |      string       |         |   yes    |
| private_subnets                   | The private subnets, minimum of 2, that are a part of the VPC(s)                                                                                                                                                                                                                                                            |      string       |         |   yes    |
| public_subnets                    | The public subnets, minimum of 2, that are a part of the VPC(s)                                                                                                                                                                                                                                                             |      string       |         |
| region                            | The AWS region to use for the environment's infrastructure.                                                                                                                                                                                                                                                                 |      string       |         |   yes    |
| environment                       | The destination environment prefix used in naming resource                                                                                                                                                                                                                                                                  |      string       |         |   yes    |
| raw_target_bucket_name            | The raw target bucket name                                                                                                                                                                                                                                                                                                  |      string       |         |   yes    |
| agg_target_bucket_name            | The agg target bucket name                                                                                                                                                                                                                                                                                                  |      string       |         |   yes    |
| hosted_zone                       | The root domain name(i.e. doppler.com)                                                                                                                                                                                                                                                                                      |      string       |         |   yes    |
| common_subdomain                  | The sub domain name(i.e. test.doppler.com)                                                                                                                                                                                                                                                                                  |      string       |         |   yes    |
| route53_zone_id                   | The zone id from the dns entry created in video env                                                                                                                                                                                                                                                                         |      string       |         |   yes    |
| container_name_app                | The name of the api container                                                                                                                                                                                                                                                                                               |      string       |   app   |   yes    |
| container_port_app                | The port the api listens on                                                                                                                                                                                                                                                                                                 |      string       |         |   yes    |
| health_check_app                  | The route to the api health check(i.e. /health)                                                                                                                                                                                                                                                                             |      string       |         |   yes    |
| ecs_autoscale_min_instances_app   | The minimum and desired # of api containers to run                                                                                                                                                                                                                                                                          |        int        |    1    |   yes    |
| ecs_autoscale_max_instances_app   | The maximum # of api containers to run                                                                                                                                                                                                                                                                                      |        int        |    5    |   yes    |
| kds_agg_shard_count               | The aggregation kinesis data streams shard count                                                                                                                                                                                                                                                                            |        int        |    1    |   yes    |
| firehose_agg_buffer_size          | The aggregation firehose buffer size                                                                                                                                                                                                                                                                                        |        int        |         |   yes    |
| firehose_agg_buffer_interval      | The aggregation firehose buffer interval                                                                                                                                                                                                                                                                                    |        int        |         |   yes    |
| kds_raw_shard_count               | The raw kinesis data streams shard count                                                                                                                                                                                                                                                                                    |        int        |         |   yes    |
| firehose_raw_buffer_size          | The raw firehose buffer size                                                                                                                                                                                                                                                                                                |        int        |         |   yes    |
| firehose_raw_buffer_interval      | The raw firehose buffer interval                                                                                                                                                                                                                                                                                            |        int        |         |   yes    |
| kda_agg_parallelism               | The agg KDA flink jobs parallelism                                                                                                                                                                                                                                                                                          |        int        |         |   yes    |
| kda_agg_parallelism_per_kpu       | The agg KDA flink jobs parallelism per kpu                                                                                                                                                                                                                                                                                  |        int        |         |   yes    |
| stream_position_raw               | The starting stream position for the agg KDA Flink job                                                                                                                                                                                                                                                                      |      string       |         |   yes    |
| ecs_task_kpl_env                  | Hardcoded environment variables for kpl sidecars                                                                                                                                                                                                                                                                            | list(map(string)) |         |   yes    |
| source_raw_target_bucket_arn      | The s3 buckets arn for the raw data from the source                                                                                                                                                                                                                                                                         |      string       |         |   yes    |
| source_raw_target_bucket_kms_arn  | The s3 buckets kms key arn for the raw data from the source                                                                                                                                                                                                                                                                 |      string       |         |   yes    |
| source_sess_target_bucket_arn     | The s3 buckets arn for the sess data from the source                                                                                                                                                                                                                                                                        |      string       |         |   yes    |
| source_sess_target_bucket_kms_arn | The s3 buckets kms key arn for the sess data from the source                                                                                                                                                                                                                                                                |      string       |         |   yes    |
| source_region                     | The source buckets region                                                                                                                                                                                                                                                                                                   |      string       |         |   yes    |

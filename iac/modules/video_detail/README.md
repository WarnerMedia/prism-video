# video_detail

## Function

- Creates most of the resources for the stack. Since there are a number of resources created here, I'll defer to the descriptions below.

## Module location(to give a frame of reference where it's used)

- Child module of video_source and video_destination

- Parent module of firehose, kda, and kds

## Contains the following terraform files

athena.tf - creates glue and athena resources to allow querying of target s3 bucket  
cicd.tf - creates iam user to allow ci cd of fargate containers  
ecs-cluster.tf - creates ecs cluster  
ecs-event-stream.tf - creates cloudwatch event rule to stream ecs logs to cloudwatch  
ecs.task-app.tf - creates app fargate container using definition  
lb-app.tf - creates app load balancer adding logging to s3 and target groups  
lb-http-app.tf - creates app http listener  
lb-https-app.tf - creates app https listener. contains logic to create ACM certs with DNS verification using route53  
lblogs-athena.tf - creates glue and athena resources to allow querying of load balancer logs  
main.tf - main entrypoint into module  
nsg-app.tf - creates app security group rules to allow communication from the load balancer to the target groups to the containers  
role-app.tf - creates app role to allow container to communicate with kinesis, sqs, cloudwatch, ssm, and kms  
lambda_buf_sess.tf - Lambda which reads from session KDS and writes to Timestream
sqs-buf-sess-dlq.tf - dead letter queue for lambda
sqs-raw-dlq.tf - dead letter queue for raw ecs task
timestream.tf - creates the Timestream database and table.
variables.tf - variables needed by this module.  
versions.tf - controls versioning of terraform resources

## Variables

| Name                            | Description                                                                                                                                                                                                                                                                                                                 |       Type        | Default | Required |
| ------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :---------------: | :-----: | :------: |
| app                             | Name of the application. This value should usually match the application tag below.                                                                                                                                                                                                                                         |      string       |         |   yes    |
| region                          | The AWS region.                                                                                                                                                                                                                                                                                                             |      string       |         |   yes    |
| tags                            | A map of the tags to apply to various resources. The required tags are: <br>+ `application`, name of the app <br>+ `environment`, the environment being created <br>+ `team`, team responsible for the application <br>+ `contact-email`, contact email for the _team_ <br>+ `customer`, who the application was create for |        map        | `<map>` |   yes    |
| internal                        | Whether the application load balancers use private or public subnets.                                                                                                                                                                                                                                                       |       bool        |  true   |   yes    |
| environment                     | The environment name(i.e. dev, test, prod, etc)                                                                                                                                                                                                                                                                             |      string       |         |   yes    |
| kpl_port                        | The port the api will communicate with the kpl on.                                                                                                                                                                                                                                                                          |        int        |         |   yes    |
| log_level                       | The verbosity of the logging. debug, info, none                                                                                                                                                                                                                                                                             |      string       |         |   yes    |
| lb_port                         | The port the load balancer listens on.                                                                                                                                                                                                                                                                                      |        int        |   80    |   yes    |
| lb_protocol                     | The protocol the load balancer uses.                                                                                                                                                                                                                                                                                        |      string       |  HTTPS  |   yes    |
| vpc                             | The VPC to use for the Fargate cluster                                                                                                                                                                                                                                                                                      |      string       |         |   yes    |
| private_subnets                 | The private subnets, minimum of 2, that are a part of the VPC(s)                                                                                                                                                                                                                                                            |      string       |         |   yes    |
| public_subnets                  | The public subnets, minimum of 2, that are a part of the VPC(s)                                                                                                                                                                                                                                                             |      string       |         |   yes    |
| logs_retention_in_days          | How long we keep the load balancer logs                                                                                                                                                                                                                                                                                     |        int        |   90    |   yes    |
| raw_target_bucket_arn           | The arn of the raw target bucket                                                                                                                                                                                                                                                                                            |      string       |         |   yes    |
| sess_target_bucket_arn          | The arn of the sess target bucket                                                                                                                                                                                                                                                                                           |      string       |         |   yes    |
| raw_target_kms_arn              | The kms arn of the raw target bucket data                                                                                                                                                                                                                                                                                   |      string       |         |   yes    |
| sess_target_kms_arn             | The kms arn of the sess target bucket                                                                                                                                                                                                                                                                                       |      string       |         |   yes    |
| raw_target_bucket_id            | The raw target bucket name                                                                                                                                                                                                                                                                                                  |      string       |         |   yes    |
| route53_zone_id                 | The zone id from the dns entry created in video env                                                                                                                                                                                                                                                                         |      string       |         |   yes    |
| hosted_zone                     | The root domain name(i.e. doppler.com)                                                                                                                                                                                                                                                                                      |      string       |         |   yes    |
| common_subdomain                | The sub domain name(i.e. test.doppler.com)                                                                                                                                                                                                                                                                                  |      string       |         |   yes    |
| ecs_as_cpu_low_threshold_per    | If the average CPU utilization over a minute drops to this threshold, the number of containers will be reduced (but not below ecs_autoscale_min_instances).                                                                                                                                                                 |      string       |   20    |   yes    |
| ecs_as_cpu_high_threshold_per   | If the average CPU utilization over a minute rises to this threshold, the number of containers will be increased (but not above ecs_autoscale_max_instances).                                                                                                                                                               |      string       |   80    |   yes    |
| container_name_app              | The name of the api container                                                                                                                                                                                                                                                                                               |      string       |   app   |   yes    |
| container_port_app              | The port the api listens on                                                                                                                                                                                                                                                                                                 |      string       |         |   yes    |
| health_check_app                | The route to the api health check(i.e. /health)                                                                                                                                                                                                                                                                             |      string       |         |   yes    |
| ecs_autoscale_min_instances_app | The minimum and desired # of api containers to run                                                                                                                                                                                                                                                                          |        int        |    1    |   yes    |
| ecs_autoscale_max_instances_app | The maximum # of api containers to run                                                                                                                                                                                                                                                                                      |        int        |    5    |   yes    |
| kds_agg_shard_count             | The aggregation kinesis data streams shard count                                                                                                                                                                                                                                                                            |        int        |    1    |   yes    |
| kds_raw_shard_count             | The raw kinesis data streams shard count                                                                                                                                                                                                                                                                                    |        int        |         |   yes    |
| firehose_agg_buffer_size        | The aggregation firehose buffer size                                                                                                                                                                                                                                                                                        |        int        |         |   yes    |
| firehose_agg_buffer_interval    | The aggregation firehose buffer interval                                                                                                                                                                                                                                                                                    |        int        |         |   yes    |
| firehose_raw_buffer_size        | The raw firehose buffer size                                                                                                                                                                                                                                                                                                |        int        |         |   yes    |
| firehose_raw_buffer_interval    | The raw firehose buffer interval                                                                                                                                                                                                                                                                                            |        int        |         |   yes    |
| kda_agg_parallelism             | The agg KDA flink jobs parallelism                                                                                                                                                                                                                                                                                          |        int        |         |   yes    |
| kda_agg_parallelism_per_kpu     | The agg KDA flink jobs parallelism per kpu                                                                                                                                                                                                                                                                                  |        int        |         |   yes    |
| stream_position_raw             | The starting stream position for the agg KDA Flink job                                                                                                                                                                                                                                                                      |      string       |         |   yes    |
| ecs_task_kpl_env                | Hardcoded environment variables for kpl sidecars                                                                                                                                                                                                                                                                            | list(map(string)) |         |   yes    |
